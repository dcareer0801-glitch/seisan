<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å‡ºé‡‘ä¼ç¥¨ã‚·ã‚¹ãƒ†ãƒ </title>
    
    <link rel="icon" href="å‡ºé‡‘.png" type="image/png">
    <link rel="apple-touch-icon" href="å‡ºé‡‘.png">

    <style>
        :root {
            --bg-color: #f0f7ff;
            --main-pink: #ff85a2;
            --main-blue: #70a1ff;
            --main-purple: #a55eea;
            --main-green: #2ecc71;
            --text-color: #2f3542;
            --card-bg: #ffffff;
            --input-bg: #f8f9fa;
        }
        body { font-family: 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif; background: var(--bg-color); color: var(--text-color); margin: 0; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        .container { background: var(--card-bg); width: 100%; max-width: 1050px; padding: 25px; border-radius: 30px; box-shadow: 0 15px 35px rgba(112, 161, 255, 0.15); }
        .ui-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 3px solid var(--bg-color); padding-bottom: 15px; }
        h1 { font-size: 1.4rem; margin: 0; color: var(--main-blue); }
        
        .data-io-btns { display: flex; gap: 8px; margin-bottom: 15px; width: 100%; max-width: 1050px; }
        .btn-export { background: #576574; color: white; border: none; padding: 8px 15px; border-radius: 10px; font-size: 12px; cursor: pointer; font-weight: bold; }
        .btn-import { background: #8395a7; color: white; border: none; padding: 8px 15px; border-radius: 10px; font-size: 12px; cursor: pointer; font-weight: bold; }

        .top-inputs { display: grid; grid-template-columns: 1.5fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        input[type="text"], select { padding: 12px; border: 2px solid #e1e8ef; border-radius: 15px; outline: none; font-size: 14px; background: var(--input-bg); transition: 0.3s; width: 100%; box-sizing: border-box; }
        table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        th { padding: 5px 10px; font-size: 13px; color: #a4b0be; text-align: center; }
        td { background: #fff; border: 2px solid #f1f2f6; height: 60px; vertical-align: middle; padding: 0 8px; transition: 0.3s; }
        td:first-child { border-radius: 15px 0 0 15px; }
        td:last-child { border-radius: 0 15px 15px 0; width: 60px; text-align: center; }
        
        .copy-input-group { display: flex; align-items: center; gap: 6px; position: relative; }
        .btn-copy-mini { border: none; background: #eef2f7; color: #7f8c8d; width: 34px; height: 34px; border-radius: 10px; cursor: pointer; font-size: 14px; transition: 0.2s; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
        .btn-copy-mini:hover { background: var(--main-blue); color: #fff; transform: scale(1.1); }
        
        @keyframes strong-flash { 0% { background-color: #fff; } 20% { background-color: #70a1ff; box-shadow: 0 0 15px #70a1ff; color: #fff; } 100% { background-color: var(--input-bg); box-shadow: 0 0 0px transparent; } }
        .copied-success { animation: strong-flash 0.8s ease forwards; }

        @keyframes auto-fill-flash { 
            0% { background-color: #fff; } 
            20% { background-color: var(--main-green); box-shadow: 0 0 20px var(--main-green); color: #fff; } 
            100% { background-color: #f3ebff; box-shadow: 0 0 0px transparent; } 
        }
        .auto-filled { animation: auto-fill-flash 1.0s ease forwards; }

        .date-input-wrapper { display: flex; align-items: center; justify-content: center; gap: 5px; }
        .date-input-cell { width: 120px; border: none !important; background: #ebf2ff !important; border-radius: 10px; padding: 10px 4px; text-align: center; font-weight: bold; color: var(--main-blue); font-size: 14px; outline: none; }
        .amount-input-cell { width: 90%; border: none; background: #f3ebff; border-radius: 12px; padding: 10px; text-align: center; font-weight: bold; color: var(--main-purple); font-size: 16px; outline: none; }
        .action-btns { display: flex; gap: 10px; margin-left: auto; align-items: center; }
        .excel-copy-btn { background: #217346; color: white; border: none; padding: 10px 18px; border-radius: 15px; font-weight: bold; cursor: pointer; font-size: 13px; }
        .btn-add { background: var(--main-pink); color: white; border: none; padding: 10px 18px; border-radius: 15px; font-weight: bold; cursor: pointer; font-size: 13px; }
        .btn-del { background: #ced6e0; color: #2f3542; border: none; padding: 10px 18px; border-radius: 15px; font-weight: bold; cursor: pointer; font-size: 13px; }
        .btn-ic-calc { background: var(--main-purple); color: white; border: none; padding: 10px 18px; border-radius: 15px; font-weight: bold; cursor: pointer; font-size: 13px; }
        
        .total-banner { margin-top: 20px; padding: 25px; border-radius: 25px; background: linear-gradient(135deg, var(--main-blue) 0%, var(--main-purple) 100%); color: white; text-align: right; font-size: 26px; font-weight: bold; }
        .tabs-container { display: flex; gap: 8px; width: 100%; max-width: 1050px; margin-top: 20px; overflow-x: auto; padding: 5px; }
        .tab { background: #dcdde1; border: none; padding: 10px 22px; border-radius: 15px 15px 5px 5px; cursor: pointer; color: #7f8c8d; font-weight: bold; white-space: nowrap; transition: 0.3s; }
        .tab.active { background: var(--main-blue); color: #fff; }
        
        #print-area { display: none; }

        @media print { 
            @page { size: B5 portrait; margin: 0; }
            html, body { background: #fff; width: 182mm; margin: 0; padding: 0; } 
            .no-print, .action-btns, .print-btn, .tabs-container, .total-banner, .container, .btn-copy-mini, .data-io-btns { display: none !important; } 
            #print-area { display: block !important; width: 182mm; } 
            .voucher-page { 
                display: block !important; 
                position: relative;
                page-break-after: always; 
                width: 182mm; 
                height: 257mm; 
                padding: 12mm; 
                box-sizing: border-box; 
                color: #000 !important; 
            } 
            .voucher-page:last-child { page-break-after: auto; } 
            
            .stamp-area {
                position: absolute;
                top: 12mm;
                right: 12mm;
                display: flex;
                border: 0.5pt solid #000;
            }
            .stamp-box {
                width: 15mm;
                border-left: 0.5pt solid #000;
                text-align: center;
            }
            .stamp-box:first-child { border-left: none; }
            .stamp-label {
                font-size: 7pt;
                height: 4mm;
                border-bottom: 0.5pt solid #000;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .stamp-space { height: 12mm; }

            .print-header {
                margin-top: 5mm;
                margin-bottom: 8mm;
            }
            .print-title {
                font-size: 22pt;
                font-weight: bold;
                text-decoration: underline;
                margin-bottom: 3mm;
            }
            .print-info-row {
                display: flex;
                justify-content: space-between;
                align-items: flex-end;
                margin-top: 5mm;
            }

            .print-table { 
                border: 1.5pt solid #000; 
                border-collapse: collapse; 
                width: 100%; 
                table-layout: fixed; 
            } 
            .print-table th, .print-table td { 
                border: 0.5pt solid #000; 
                height: 10.5mm; 
                font-size: 10.5pt; 
                text-align: center; 
                background: transparent !important; 
                color: #000 !important; 
            } 
            .print-total-row { 
                font-size: 14pt !important; 
                font-weight: bold !important; 
                background: #eee !important; 
                height: 12mm; 
            } 
        }
        
        .print-btn { position: fixed; bottom: 30px; right: 30px; background: var(--text-color); color: white; border: none; padding: 18px 35px; border-radius: 50px; font-weight: bold; cursor: pointer; z-index: 100; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

<div class="data-io-btns no-print">
    <button class="btn-export" onclick="exportData()">ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ï¼ˆé…å¸ƒç”¨ï¼‰</button>
    <button class="btn-import" onclick="document.getElementById('import-file').click()">ğŸ“‚ ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€</button>
    <input type="file" id="import-file" style="display:none" onchange="importData(this)">
</div>

<div class="tabs-container no-print" id="tabs-bar">
    <div class="action-btns">
        <button class="btn-ic-calc" onclick="location.href='densya.html'">ğŸ’³ ICæ®‹é«˜è¨ˆç®—</button>
        <button class="excel-copy-btn" id="copy-btn" onclick="copyCurrentTabForExcel(this)">ğŸ“Š è¡¨ç¤ºä¸­ã®ä¼ç¥¨ã‚’ã‚³ãƒ”ãƒ¼</button>
        <button class="btn-add" onclick="addNewVoucher()">âœ¨ ä¼ç¥¨ã‚’è¿½åŠ </button>
        <button class="btn-del" onclick="deleteCurrentVoucher()">ğŸ—‘ï¸ ä¼ç¥¨ã‚’å‰Šé™¤</button>
    </div>
</div>

<div class="container no-print">
    <div class="ui-header">
        <h1>ğŸ“‘ å‡ºé‡‘ä¼ç¥¨ã‚·ã‚¹ãƒ†ãƒ </h1>
        <div style="display:flex; align-items:center; gap:15px; background: var(--bg-color); padding: 8px 20px; border-radius: 50px;">
            <button style="background:#fff; border:2px solid var(--main-blue); border-radius:50%; width:30px; height:30px; cursor:pointer;" onclick="changeMonth(-1)">â€¹</button>
            <span id="target-month-label" style="font-weight: bold;"></span>
            <button style="background:#fff; border:2px solid var(--main-blue); border-radius:50%; width:30px; height:30px; cursor:pointer;" onclick="changeMonth(1)">â€º</button>
        </div>
    </div>
    <div class="top-inputs">
        <input type="text" id="ui-name" placeholder="ãŠåå‰" oninput="syncGlobalName(this.value)">
        <input type="text" id="ui-date" placeholder="ä½œæˆæ—¥ (æœˆ/æ—¥)" onchange="syncGlobalDate(this.value)">
        <select id="office-select" onchange="syncGlobalOffice(this.value)">
            <option value="æšæ–¹é§…å‰ã‚ªãƒ•ã‚£ã‚¹">æšæ–¹é§…å‰ã‚ªãƒ•ã‚£ã‚¹</option>
            <option value="ITEXäº¬æ©‹ã‚ªãƒ•ã‚£ã‚¹">ITEXäº¬æ©‹ã‚ªãƒ•ã‚£ã‚¹</option>
        </select>
    </div>
    <div id="editor-area"></div>
    <div class="total-banner">åˆè¨ˆé‡‘é¡ï¼š Â¥ <span id="ui-total-display">0</span></div>
</div>
<div id="print-area"></div>
<button class="print-btn no-print" onclick="window.print()">ğŸ–¨ï¸ å°åˆ·ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¸</button>

<script>
    let curY, curM, activeIdx = 0;
    let fareMemory = JSON.parse(localStorage.getItem('fareMemory')) || {};
    let voucherData = JSON.parse(localStorage.getItem('voucherData')) || {};
    let globalName = localStorage.getItem('globalName') || "";

    window.onload = () => {
        const now = new Date();
        curY = now.getFullYear(); curM = now.getMonth() + 1;
        init();
        checkTransferredData();
    };

    function init() {
        const key = `${curY}-${curM}`;
        if (!voucherData[key]) voucherData[key] = { office: "æšæ–¹é§…å‰ã‚ªãƒ•ã‚£ã‚¹", date: "", list: [createRows()] };
        voucherData[key].list = voucherData[key].list.map((v, i) => v.data ? v : { name: "", data: v });
        render();
    }

    function checkTransferredData() {
        const rawData = localStorage.getItem('transferData');
        if (!rawData) return;
        
        let newData = JSON.parse(rawData);
        const key = `${curY}-${curM}`;
        let currentRows = voucherData[key].list[activeIdx].data;
        
        newData.forEach(item => {
            let emptyIdx = currentRows.findIndex(r => !r.d && !r.a);
            if (emptyIdx !== -1) {
                currentRows[emptyIdx] = item;
            } else {
                const newVoucher = createRows();
                newVoucher.name = `ä¼ç¥¨ ${voucherData[key].list.length + 1}`;
                newVoucher.data[0] = item;
                voucherData[key].list.push(newVoucher);
                currentRows = voucherData[key].list[voucherData[key].list.length - 1].data;
            }
        });

        localStorage.removeItem('transferData'); 
        save(); render();
        alert(newData.length + "ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’åæ˜ ã—ã¾ã—ãŸã€‚\næ ãŒè¶³ã‚Šãªã„åˆ†ã¯æ–°ã—ã„ä¼ç¥¨ã‚’è‡ªå‹•ä½œæˆã—ã¾ã—ãŸã€‚");
    }

    function createRows() { return { name: "", data: Array(16).fill().map(() => ({ d: "", p: "", c: "", a: "" })) }; }

    function normalizeText(str) {
        if (!str) return "";
        return str.replace(/[é§…å¸‚\s\t\(\)ï¼ˆï¼‰]/g, '').replace(/[ï¼ï½°â€”â€•â”€â”ãƒ¼~ï½-]/g, 'ãƒ¼').split('').sort().join('');
    }

    function formatSmartDate(val) {
        if (!val) return "";
        let clean = val.replace(/\//g, '-');
        if (!isNaN(clean) && clean.length <= 2) return `${curY}/${String(curM).padStart(2, '0')}/${String(clean).padStart(2, '0')}`;
        if (clean.includes('-')) {
            let parts = clean.split('-');
            if (parts.length === 2) return `${curY}/${parts[0].padStart(2, '0')}/${parts[1].padStart(2, '0')}`;
        }
        return val.replace(/-/g, '/');
    }

    function handleContentConfirm(rIdx, val) {
        updateCell(rIdx, 'c', val);
        const norm = normalizeText(val);
        if (fareMemory[norm]) {
            updateCell(rIdx, 'a', fareMemory[norm]);
            render();
            setTimeout(() => {
                const amountInputs = document.querySelectorAll('.amount-input-cell');
                if(amountInputs[rIdx]) {
                    amountInputs[rIdx].classList.add('auto-filled');
                    setTimeout(() => amountInputs[rIdx].classList.remove('auto-filled'), 1000);
                }
            }, 50);
        }
    }

    // â˜…â˜…â˜… é‡‘é¡å…¥åŠ›æ™‚ã®ä¿å­˜ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã€ŒåŒºé–“è¨˜å·ãŒã‚ã‚‹æ™‚ã®ã¿ã€ã«é™å®š â˜…â˜…â˜…
    function handleAmountConfirm(rIdx, val) {
        const cleanVal = val.replace(/[^0-9]/g, '');
        updateCell(rIdx, 'a', cleanVal);
        const content = voucherData[`${curY}-${curM}`].list[activeIdx].data[rIdx].c;
        
        if (!content || !cleanVal) return;

        // å†…å®¹ã«åŒºé–“ã‚’ç¤ºã™è¨˜å·ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        const isRoute = /[-ãƒ¼ï¼ï½~â†’]/.test(content);
        
        // ç§»å‹•åŒºé–“ï¼ˆè¨˜å·ã‚ã‚Šï¼‰ã®å ´åˆã®ã¿ä¿å­˜ã™ã‚‹
        if (isRoute) {
            const norm = normalizeText(content);
            fareMemory[norm] = cleanVal; 
            localStorage.setItem('fareMemory', JSON.stringify(fareMemory));
        }
    }

    async function execCopy(btn) {
        const input = btn.previousElementSibling;
        const text = input.value;
        if (!text) return;
        try {
            await navigator.clipboard.writeText(text);
            btn.innerText = "âœ…";
            input.classList.add('copied-success');
            setTimeout(() => { btn.innerText = "ğŸ“‹"; input.classList.remove('copied-success'); }, 800);
        } catch (err) { console.error('Copy failed', err); }
    }

    function renameTab(idx) {
        const key = `${curY}-${curM}`;
        const currentName = voucherData[key].list[idx].name || `ä¼ç¥¨ ${idx + 1}`;
        const newName = prompt("ã‚¿ãƒ–ã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", currentName);
        if (newName !== null) { voucherData[key].list[idx].name = newName; save(); render(); }
    }

    function render() {
        const key = `${curY}-${curM}`;
        const data = voucherData[key];
        document.getElementById('target-month-label').innerText = `${curY}å¹´ ${curM}æœˆ`;
        document.getElementById('ui-name').value = globalName;
        document.getElementById('ui-date').value = data.date || "";
        document.getElementById('office-select').value = data.office || "æšæ–¹é§…å‰ã‚ªãƒ•ã‚£ã‚¹";

        const bar = document.getElementById('tabs-bar');
        bar.querySelectorAll('.tab').forEach(t => t.remove());
        data.list.forEach((v, i) => {
            const btn = document.createElement('button');
            btn.className = `tab ${i === activeIdx ? 'active' : ''}`;
            btn.innerText = v.name || `ä¼ç¥¨ ${i + 1}`;
            btn.onclick = () => { if (i === activeIdx) renameTab(i); else { activeIdx = i; render(); } };
            bar.insertBefore(btn, bar.firstChild);
        });

        const area = document.getElementById('editor-area');
        const rows = data.list[activeIdx].data;
        let html = `<table><tr><th width="180px">æ—¥ä»˜</th><th width="25%">æ”¯æ‰•å…ˆ</th><th width="32%">å†…å®¹</th><th width="15%">é‡‘é¡</th><th width="60px"></th></tr>`;
        rows.forEach((r, i) => {
            html += `<tr>
                <td><div class="date-input-wrapper"><input type="text" class="date-input-cell" value="${r.d}" onchange="updateCell(${i},'d',formatSmartDate(this.value))" placeholder="MM/DD"><span style="cursor:pointer; font-size: 20px;" onclick="this.nextElementSibling.showPicker()">ğŸ“…</span><input type="date" style="position:absolute;opacity:0;width:0;pointer-events:none;" onchange="updateCell(${i},'d',this.value.replace(/-/g,'/'))"></div></td>
                <td><div class="copy-input-group"><input type="text" value="${r.p}" onchange="updateCell(${i},'p',this.value)"><button class="btn-copy-mini" onclick="execCopy(this)">ğŸ“‹</button></div></td>
                <td><div class="copy-input-group"><input type="text" value="${r.c}" onchange="handleContentConfirm(${i},this.value)"><button class="btn-copy-mini" onclick="execCopy(this)">ğŸ“‹</button></div></td>
                <td><input type="text" class="amount-input-cell" value="${r.a}" onchange="handleAmountConfirm(${i},this.value)" onfocus="this.select()"></td>
                <td><button style="border:none;background:none;color:var(--main-pink);cursor:pointer;font-size:18px;" onclick="clearRow(${i})">ğŸ—‘ï¸</button></td>
            </tr>`;
        });
        area.innerHTML = html + `</table>`;
        updateTotal(); preparePrint();
    }

    function updateCell(rIdx, field, val) {
        voucherData[`${curY}-${curM}`].list[activeIdx].data[rIdx][field] = val;
        save(); if (field === 'd') render(); else { updateTotal(); preparePrint(); }
    }

    function save() { localStorage.setItem('voucherData', JSON.stringify(voucherData)); }
    function syncGlobalName(val) { globalName = val; localStorage.setItem('globalName', globalName); preparePrint(); }
    function syncGlobalDate(val) { const key = `${curY}-${curM}`; voucherData[key].date = formatSmartDate(val); save(); render(); }
    function syncGlobalOffice(val) { const key = `${curY}-${curM}`; voucherData[key].office = val; save(); preparePrint(); }

    function updateTotal() {
        const rows = voucherData[`${curY}-${curM}`].list[activeIdx].data;
        const total = rows.reduce((s, r) => s + (parseInt(r.a) || 0), 0);
        document.getElementById('ui-total-display').innerText = total.toLocaleString();
    }

    function exportData() {
        const displayMonth = String(curM).padStart(2, '0');
        const fileNameName = globalName || 'æœªå…¥åŠ›';
        const data = { globalName: globalName, voucherData: voucherData, fareMemory: fareMemory };
        const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${curY}å¹´${displayMonth}æœˆåˆ†_${fileNameName}_å‡ºé‡‘ä¼ç¥¨.json`;
        a.click();
        setTimeout(() => URL.revokeObjectURL(url), 100);
    }

    function importData(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                if (data.globalName) { globalName = data.globalName; localStorage.setItem('globalName', globalName); }
                if (data.voucherData) { 
                    voucherData = data.voucherData; 
                    Object.keys(voucherData).forEach(k => { voucherData[k].list = voucherData[k].list.map(v => v.data ? v : { name: "", data: v }); });
                    localStorage.setItem('voucherData', JSON.stringify(voucherData)); 
                }
                if (data.fareMemory) { fareMemory = data.fareMemory; localStorage.setItem('fareMemory', JSON.stringify(fareMemory)); }
                alert('ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼'); activeIdx = 0; init();
            } catch (err) { alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“'); }
        };
        reader.readAsText(file);
    }

    function addNewVoucher() {
        const key = `${curY}-${curM}`;
        voucherData[key].list.push(createRows());
        activeIdx = voucherData[key].list.length - 1;
        save(); render();
    }
    function deleteCurrentVoucher() {
        const key = `${curY}-${curM}`;
        if (voucherData[key].list.length <= 1) return;
        if (confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) { voucherData[key].list.splice(activeIdx, 1); activeIdx = 0; save(); render(); }
    }
    function changeMonth(n) {
        curM += n; if (curM > 12) { curM = 1; curY++; } else if (curM < 1) { curM = 12; curY--; }
        activeIdx = 0; init();
    }
    function clearRow(i) {
        if (confirm("ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ")) { voucherData[`${curY}-${curM}`].list[activeIdx].data[i] = { d: "", p: "", c: "", a: "" }; save(); render(); }
    }

    function preparePrint() {
        const key = `${curY}-${curM}`;
        const data = voucherData[key];
        const pArea = document.getElementById('print-area');
        if (!pArea) return;
        pArea.innerHTML = '';
        data.list.forEach((v) => {
            let rowsPrint = v.data.filter(r => r.d || (r.a && parseInt(r.a) > 0));
            rowsPrint.sort((a, b) => { if (!a.d) return 1; if (!b.d) return -1; return new Date(a.d) - new Date(b.d); });
            while(rowsPrint.length < 16) rowsPrint.push({d:"",p:"",c:"",a:""});
            const total = rowsPrint.reduce((s, r) => s + (parseInt(r.a) || 0), 0);
            const page = document.createElement('div');
            page.className = 'voucher-page';
            page.innerHTML = `
                <div class="stamp-area">
                    <div class="stamp-box" style="width:45mm;">
                        <div class="stamp-label">æ‰¿èªå°</div>
                        <div style="display:flex;">
                            <div style="width:15mm; height:12mm; border-right:0.5pt solid #000;"></div>
                            <div style="width:15mm; height:12mm; border-right:0.5pt solid #000;"></div>
                            <div style="width:15mm; height:12mm;"></div>
                        </div>
                    </div>
                    <div class="stamp-box">
                        <div class="stamp-label">ä¿‚å°</div>
                        <div class="stamp-space"></div>
                    </div>
                </div>

                <div class="print-header">
                    <div class="print-title">å‡ºé‡‘ä¼ç¥¨</div>
                    <div class="print-info-row">
                        <div style="font-size:11pt;">ä½œæˆæ—¥: ${data.date || 'ã€€å¹´ã€€æœˆã€€æ—¥'}</div>
                        <div style="text-align:right;">
                            <div style="font-size:10pt; margin-bottom:1mm;">${data.office}</div>
                            <div style="border-bottom:1pt solid #000; width:60mm; font-size:12pt; padding-bottom:1mm;">æ°åï¼š ${globalName}</div>
                        </div>
                    </div>
                </div>

                <table class="print-table">
                    <thead><tr><th width="18%">æ—¥ä»˜</th><th width="24%">æ”¯æ‰•å…ˆ</th><th width="38%">å†…å®¹</th><th width="20%">é‡‘é¡</th></tr></thead>
                    <tbody>${rowsPrint.map(r => `<tr>
                        <td>${r.d || ''}</td><td>${r.p || ''}</td><td>${r.c || ''}</td>
                        <td style="text-align:right; padding-right:8px;">${r.a ? 'Â¥ ' + parseInt(r.a).toLocaleString() : ''}</td>
                    </tr>`).join('')}</tbody>
                    <tr class="print-total-row"><td colspan="3" style="text-align:right; padding-right:15px;">åˆè¨ˆ</td><td style="text-align:right; padding-right:8px;">Â¥ ${total.toLocaleString()}</td></tr>
                </table>`;
            pArea.appendChild(page);
        });
    }

    async function copyCurrentTabForExcel(btn) {
        const key = `${curY}-${curM}`;
        const data = voucherData[key];
        const currentRows = data.list[activeIdx].data;
        let tsv = "";
        let validRows = currentRows.filter(r => r.d || (r.a && parseInt(r.a) > 0));
        validRows.sort((a, b) => new Date(a.d) - new Date(b.d));
        validRows.forEach((r, index) => {
            const rowDate = (index === 0) ? (data.date || "") : "";
            const rowSummary = `${r.d} ${r.p} ${r.c}`.trim();
            tsv += `${rowDate}\t${rowSummary}\t\t${r.a}\t\n`;
        });
        if (!tsv) { alert("ã‚³ãƒ”ãƒ¼ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“"); return; }
        await navigator.clipboard.writeText(tsv);
        btn.innerText = "âœ… ã‚³ãƒ”ãƒ¼æ¸ˆ";
        setTimeout(() => { btn.innerText = "ğŸ“Š è¡¨ç¤ºä¸­ã®ä¼ç¥¨ã‚’ã‚³ãƒ”ãƒ¼"; }, 2000);
    }
</script>
</body>
</html>